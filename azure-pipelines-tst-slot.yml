# PHP as Linux Web App on Azure
trigger:
  - Test-Slot

variables:
  azureSubscription: "app-azuredevops-groupegruau-pipelines-prd"
  azureTstSubscription: "app-azuredevops-groupegruau-pipelines-tst"
  webAppName: "app-gruau-prd-test-slot"
  vmImageName: "ubuntu-latest"
  environmentName: "app-gruau-prd-test-slot"
  rgName: "rg-prd-webapps"
  slotName: "preprod"
  rootFolder: $(System.DefaultWorkingDirectory)

stages:
  - stage: Build
    displayName: Build stage
    variables:
      phpVersion: "8.2"
    jobs:
      - job: BuildJob
        pool:
          vmImage: $(vmImageName)
        steps:
          - script: |
              sudo update-alternatives --set php /usr/bin/php$(phpVersion)
              sudo update-alternatives --set phar /usr/bin/phar$(phpVersion)
              sudo update-alternatives --set phpdbg /usr/bin/phpdbg$(phpVersion)
              sudo update-alternatives --set php-cgi /usr/bin/php-cgi$(phpVersion)
              sudo update-alternatives --set phar.phar /usr/bin/phar.phar$(phpVersion)
              php -version
            displayName: "Use PHP version $(phpVersion)"

          # Installer Composer mais sans l'exécuter immédiatement
          - script: composer install --no-dev --no-ansi --no-interaction --no-progress --prefer-dist --no-scripts
            displayName: "Prepare Composer dependencies (no vendor folder in ZIP)"

          # Installer npm mais sans exécuter de build
          - script: npm ci --ignore-scripts
            displayName: "Prepare npm dependencies (no node_modules in ZIP)"

          # Supprimer `vendor` et `node_modules` avant l'archivage
          - script: |
              rm -rf vendor node_modules
            displayName: "Remove dependencies before archiving"

          - task: ArchiveFiles@2
            displayName: "Archive files"
            inputs:
              rootFolderOrFile: "$(rootFolder)"
              includeRootFolder: false
              archiveType: zip
              archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
              replaceExistingArchive: true

          - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
            displayName: "Upload package"
            artifact: drop

  - stage: Deploy
    displayName: "Deploy Web App"
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeploymentJob
        pool:
          vmImage: $(vmImageName)
        environment: $(environmentName)
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: "Déploiement rapide avec ZIP Deploy"
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'pscore'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az webapp deployment source config-zip --resource-group $(rgName) --name $(webAppName) --slot $(slotName) --src "$(Pipeline.Workspace)/drop/$(Build.BuildId).zip"

                # Installer Composer et npm après le déploiement
                - task: AzureCLI@2
                  displayName: "Forcer installation après déploiement via Kudu"
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      curl -u $(USERNAME):$(PASSWORD) -X POST "https://$(webAppName).scm.azurewebsites.net/api/command" -d '{ "command": "composer install --no-dev --prefer-dist && npm ci && php bin/console cache:clear --no-warmup", "dir": "D:\\home\\site\\wwwroot" }'

